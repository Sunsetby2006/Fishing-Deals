<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proceso de pago</title>
    <link rel="stylesheet" href="stylePago.css">
    <style>
        /* Estilos adicionales para las nuevas funcionalidades */
        .campo-valido { border-color: #28a745 !important; }
        .campo-invalido { border-color: #dc3545 !important; }
        .costo-envio { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 5px; 
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .tiempo-contador {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        .animacion-campo {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="pago-simulado">
    <div class="contenedor-direccion">
        <header>
            <h1>formulario de direccion / pago</h1>
        </header>

        <main>
            <form class="formulario-pago">
                <section>
                    <h2>Datos de domicilio</h2>

                    <div class="campo-formulario animacion-campo">
                        <label for="calle" class="form-direccion">Calle</label>
                        <input type="text" id="calle" name="calle" class="form-control required"/>
                    </div>

                    <div class="campo-formulario animacion-campo">
                        <label for="numero">Numero</label>
                        <input type="number" id="numero" name="numero" class="form-control" required>
                    </div>

                    <div class="campo-formulario animacion-campo">
                        <label for="ciudad">Ciudad</label>
                        <input type="text" id="ciudad" name="ciudad" class="form-control" required>
                    </div>

                    <div class="campo-formulario animacion-campo">
                        <label for="codigo-postal">Codigo postal</label>
                        <input type="number" id="codigo-postal" name="codigo-postal" class="form-control" required>
                    </div>

                    <!-- Sección de costo de envío -->
                    <div id="costo-envio-container" class="costo-envio" style="display: none;">
                        <strong>Costo de envío estimado: $<span id="costo-envio">0.00</span></strong>
                    </div>

                    <div class="campo-pago">
                        <h3>Selecciona metodo de pago</h3>
                        
                        <!--Tarjeta de credito-->
                        <div class="opcion-pago">
                            <input type="radio" id="tarjeta-credito" name="metodo-pago" value="credito" required>
                            <label for="tarjeta-credito">Tarjeta de Credito</label>
                        </div>
                        <!-- Tarjeta de debito -->
                        <div class="opcion-pago">
                            <input type="radio" id="tarjeta-debito" name="metodo-pago" value="debito" required>
                            <label for="tarjeta-debito">Tarjeta de debito</label>
                        </div>
                        <!-- Pago en Tienda -->
                        <div class="opcion-pago">
                            <input type="radio" id="pago-tienda" name="metodo-pago" value="tienda">
                            <label for="pago-tienda">Pagar en Tienda</label>
                        </div>
                        
                        <!-- Transferencia Bancaria -->
                        <div class="opcion-pago">
                            <input type="radio" id="transferencia" name="metodo-pago" value="transferencia">
                            <label for="transferencia">Transferencia Bancaria</label>
                        </div>

                        <!-- campo dinamico -->
                        <div id="campos-pago-dinamicos" class="campos-pago-dinamicos">
                            <!-- Aquí aparecerán los campos según el método seleccionado -->
                        </div>
                    </div>

                    <!-- Botón de envío -->
                    <div class="campo-formulario">
                        <button type="submit" id="btn-submit" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 5px; font-size: 1.1rem; cursor: pointer;">
                            Completar Pago
                        </button>
                    </div>
                </section>
            </form>
        </main>
    </div>

    <!-- Contador de tiempo -->
    <div class="tiempo-contador" id="tiempo-contador">
        Tiempo: 0s
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startTime = new Date();
            let tiempoInterval;

            // 1. Contador de tiempo
            function actualizarTiempo() {
                const currentTime = new Date();
                const segundos = Math.floor((currentTime - startTime) / 1000);
                document.getElementById('tiempo-contador').textContent = `Tiempo: ${segundos}s`;
            }
            tiempoInterval = setInterval(actualizarTiempo, 1000);

            // 2. Cargar datos guardados
            const savedData = localStorage.getItem('formularioPago');
            if (savedData) {
                const formData = JSON.parse(savedData);
                Object.keys(formData).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = formData[key];
                        if (key === 'codigo-postal') {
                            calcularCostoEnvio();
                            sugerirCiudad();
                        }
                    }
                });
            }

            // 3. Validación en tiempo real
            document.querySelectorAll('.contenedor-direccion input').forEach(input => {
                input.addEventListener('blur', function() {
                    if (this.value.trim() === '' && this.hasAttribute('required')) {
                        this.classList.add('campo-invalido');
                        this.classList.remove('campo-valido');
                    } else if (this.value.trim() !== '') {
                        this.classList.add('campo-valido');
                        this.classList.remove('campo-invalido');
                    }
                });

                // 4. Guardado automático
                input.addEventListener('input', function() {
                    guardarEnLocalStorage();
                    
                    // 5. Animación al completar
                    if (this.value.trim() !== '') {
                        this.parentElement.style.transform = 'scale(1.02)';
                        setTimeout(() => {
                            this.parentElement.style.transform = 'scale(1)';
                        }, 200);
                    }
                });
            });

            // 6. Cálculo de costo de envío - CORREGIDO
            function calcularCostoEnvio() {
                const cp = document.getElementById('codigo-postal').value;
                const costoContainer = document.getElementById('costo-envio-container');
                
                if (cp.length === 5) {
                    let costoBase = 50;
                    if (cp.startsWith('01') || cp.startsWith('02') || cp.startsWith('03')) {
                        costoBase = 30;
                    } else if (cp.startsWith('44') || cp.startsWith('45')) {
                        costoBase = 60;
                    } else if (cp.startsWith('64') || cp.startsWith('65')) {
                        costoBase = 80;
                    } else {
                        costoBase = 100;
                    }
                    
                    const costoFinal = costoBase + (Math.random() * 20);
                    document.getElementById('costo-envio').textContent = costoFinal.toFixed(2);
                    costoContainer.style.display = 'block';
                } else {
                    costoContainer.style.display = 'none';
                }
            }

            // 7. Sugerir ciudad por código postal - CORREGIDO
            function sugerirCiudad() {
                const cpInput = document.getElementById('codigo-postal');
                const ciudadInput = document.getElementById('ciudad');
                
                if (cpInput && ciudadInput) {
                    const cp = cpInput.value;
                    
                    if (cp.length === 5) {
                        const ciudades = {
                            '01000': 'Ciudad de México', '02000': 'Ciudad de México', '03000': 'Ciudad de México',
                            '44100': 'Guadalajara', '44200': 'Guadalajara', '44300': 'Guadalajara',
                            '64000': 'Monterrey', '64100': 'Monterrey', '64200': 'Monterrey',
                            '80000': 'Culiacán', '20000': 'Aguascalientes', '36000': 'Guanajuato',
                            '25000': 'Saltillo', '28000': 'Colima', '45000': 'Zapopan',
                            '83100': 'Hermosillo', '21000': 'Mexicali', '86000': 'Villahermosa'
                        };
                        
                        if (ciudades[cp] && !ciudadInput.value) {
                            ciudadInput.value = ciudades[cp];
                        }
                    }
                }
            }

            // Eventos para código postal
            const cpInput = document.getElementById('codigo-postal');
            if (cpInput) {
                cpInput.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9]/g, '').slice(0, 5);
                    if (this.value.length === 5) {
                        setTimeout(sugerirCiudad, 300);
                        calcularCostoEnvio();
                    }
                });
                
                cpInput.addEventListener('blur', function() {
                    sugerirCiudad();
                    calcularCostoEnvio();
                });
            }

            // 8. Formato de tarjeta de crédito
            document.addEventListener('input', function(e) {
                if (e.target.id === 'numero-tarjeta') {
                    let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ');
                    if (formattedValue) e.target.value = formattedValue;
                }
            });

            // 9. Guardar en localStorage
            function guardarEnLocalStorage() {
                const formData = {
                    calle: document.getElementById('calle').value,
                    numero: document.getElementById('numero').value,
                    ciudad: document.getElementById('ciudad').value,
                    'codigo-postal': document.getElementById('codigo-postal').value
                };
                localStorage.setItem('formularioPago', JSON.stringify(formData));
            }

            // 10. Manejo de envío del formulario
            document.querySelector('.formulario-pago').addEventListener('submit', function(e) {
                e.preventDefault();
                const endTime = new Date();
                const tiempoSegundos = (endTime - startTime) / 1000;
                clearInterval(tiempoInterval);
                
                alert(`¡Formulario completado en ${tiempoSegundos.toFixed(1)} segundos!\n\nPago procesado exitosamente.`);
                localStorage.removeItem('formularioPago');
            });

            // Campos dinámicos de métodos de pago
            const radios = document.querySelectorAll('input[name="metodo-pago"]');
            const contenedor = document.getElementById('campos-pago-dinamicos');
            
            radios.forEach(radio => {
                radio.addEventListener('change', function() {
                    contenedor.innerHTML = '';
                    
                    if (this.value === 'credito' || this.value === 'debito') {
                        const tipo = this.value === 'credito' ? 'Crédito' : 'Débito';
                        
                        contenedor.innerHTML = `
                            <div class="campo-formulario animacion-campo">
                                <label for="numero-tarjeta">Número de tarjeta</label>
                                <input type="text" id="numero-tarjeta" name="numero-tarjeta" maxlength="16" placeholder="1234 5678 9012 3456" required>
                            </div>
                            <div class="campo-formulario animacion-campo">
                                <label for="fecha-vencimiento">Fecha de vencimiento</label>
                                <input type="text" id="fecha-vencimiento" name="fecha-vencimiento" placeholder="MM/AA" required>
                            </div>
                            <div class="campo-formulario animacion-campo">
                                <label for="cvv">CVV</label>
                                <input type="text" id="cvv" name="cvv" maxlength="3" placeholder="123" required>
                            </div>
                            <div class="campo-formulario animacion-campo">
                                <label for="nombre-tarjeta">Nombre en la tarjeta</label>
                                <input type="text" id="nombre-tarjeta" name="nombre-tarjeta" placeholder="JUAN PEREZ" required>
                            </div>
                        `;
                    }
                    else if (this.value === 'transferencia') {
                        contenedor.innerHTML = `
                            <div class="campo-formulario">
                                <p><strong>Datos para transferencia:</strong></p>
                                <p>Banco: Mi Banco</p>
                                <p>Cuenta: 1234-5678-9012-3456</p>
                                <p>CLABE: 012345678901234567</p>
                            </div>
                            <div class="campo-formulario animacion-campo">
                                <label for="comprobante">Subir comprobante</label>
                                <input type="file" id="comprobante" name="comprobante" accept=".pdf,.jpg,.png" required>
                            </div>
                        `;
                    }
                    else if (this.value === 'tienda') {
                        contenedor.innerHTML = `
                            <div class="campo-formulario">
                                <p><strong>Pago en tienda</strong></p>
                                <p>Presenta este código en cualquier sucursal:</p>
                                <div style="background: #f0f0f0; padding: 10px; text-align: center; font-weight: bold; font-size: 1.2rem;">
                                    COD-${Math.random().toString(36).substr(2, 6).toUpperCase()}
                                </div>
                                <p style="margin-top: 10px; font-size: 0.9rem;">Tu pedido estará reservado por 24 horas</p>
                            </div>
                        `;
                    }
                });
            });
        });
    </script>
</body>
</html>